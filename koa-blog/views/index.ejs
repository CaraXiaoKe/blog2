<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>前端开发|一滴水博客</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="renderer" content="webkit">
		<meta name="keywords" content="前端，后端，Vue，Node，Javascript，生活">
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
		<link rel="stylesheet" href="/styles/layout.css">
		<link rel="stylesheet" href="//at.alicdn.com/t/font_532447_ems19ao9ehh69a4i.css">
	</head>
	<body>
		<div class="g">
			<%- include nav.ejs %>
			<div class="g-con">
				<div class="m-con">
					<div class="wrap">
						<div class="tc" id="paginationTop"></div>
						<div id="articles">
						<% posts.forEach(function(post){ %>
							<article class="u-art">
								<header class="tc">
									<h2 class="title"><%= post.title %></h2>
								</header>
								<% if(post.image!==""&&!isMobile){ %>
									<div class="con have-img">
										<a class="wrap-img" href="<%= __URL %>/article/<%= post._id %>">
											<img class="img-fit lazy" data-original="<%= post.image %>?imageView2/1/w/300/h/240">
										</a>
										<p class="abs"><%= post.des %></p>
									</div>
								<% }else{ %>
									<div class="con">
										<p class="abs"><%= post.des %></p>
									</div>
								<% } %>
								<div class="btn__wrapper">
									<a class="btn--blue" href="<%= __URL %>/article/<%= post._id %>">阅读更多</a>
								</div>
								<div class="meta clear">
									<a class="left"><%= post.user_name %> 发表于 <%= post.created_at %></a>
									<a class="right">
									<% if(config_cate[post.cate]&&config_cate[post.cate].sub){ %>
										<span class="type"><%= config_cate[post.cate].name %>-<%= config_cate[post.cate].sub[post.sub_cate] %>
									<% } %></span><span class="view">&nbsp;<i class="iconfont icon-liulan"></i> <%= post.views %></span>
									</a>
								</div>
							</article>
						<% }) %>
						</div>
						<div class="tc mt30" id="pagination"></div>
						<!-- <a data-id="2" href="javascript:;" class="btn-wrap" onclick="loadMore(event)">
							加载更多
						</a> -->
					</div>
				</div>
				<%- include aside.ejs %>
			</div>
		</div>
		<script id="interpolationtmpl" type="text/x-dot-template">
			{{~it.data:post:index}}
				<article class="u-art">
					<header class="tc">
						<h2 class="title">{{= post.title }}</h2>
					</header>
					{{? !!post.image && !<%= isMobile %> }}
						<div class="con have-img">
							<a class="wrap-img" href="<%= __URL %>/article/{{= post._id }}">
								<img class="img-fit lazy" data-original="{{= post.image }}?imageView2/1/w/300/h/240">
							</a>
							<p class="abs">{{= post.des }}</p>
						</div>
					{{??}}
						<div class="con">
							<p class="abs">{{= post.des }}</p>
						</div>
					{{?}}
					<div class="btn__wrapper">
						<a class="btn--blue" href="<%= __URL %>/article/{{= post._id}}">阅读更多</a>
					</div>
					<div class="meta clear">
						<a class="left">{{= post.user_name }}发表于 {{= post.created_at }}</a>
						<a class="right">
					{{? post.cate_name&&post.sub_cate_name }}
						<span class="type">{{= post.cate_name }}-{{= post.sub_cate_name }}</span>
					{{?}}<span class="view">&nbsp;<i class="iconfont icon-liulan"></i> {{= post.views }}</span>
					</a>
					</div>
				</article>
			{{~}}
		</script>
		<script id="paginationTpl" type="text/x-dot-template">
			<ul class="pagination">
				{{? it.current==1 }}
			    	<li class="disabled"><a>首页</a></li> 
				{{??}}
					<li><a href="<%= __URL %>/p/1" onclick="setCurrent(1,event);loadNewPage(1);return false;"> 首页 </a></li>
					<li><a href="<%= __URL %>/p/{{= it.current-1 }}" onclick="setCurrent({{= it.current-1 }},event);loadNewPage({{= it.current-1 }});return false;"> 上一页 </a></li>
				{{?}}
				{{~it.lists:p:index}}
					{{? it.current==p.val}}
			    		<li class="active"><a>{{= p.text }}</a></li>
			    	{{??}}
			    		<li><a href="<%= __URL %>/p/{{= p.val }}" onclick="setCurrent({{= p.val }},event);loadNewPage({{= p.val }});return false;"> {{= p.text }} </a></li>
			    	{{?}}
			    {{~}} 
			    {{? it.current===it.page }}
				    <li class="disabled"><a> 尾页 </a></li>
			    {{??}}
			    	<li>
				    	<a href="<%= __URL %>/p/{{= it.current+1 }}" onclick="setCurrent({{= it.current+1 }},event);loadNewPage({{= it.current+1 }});return false;"> 下一页</a>
				    </li>
			    	<li><a href="<%= __URL %>/p/{{= it.page }}" onclick="setCurrent({{= it.page }},event);loadNewPage({{= it.page }});return false;"> 尾页 </a></li>
			    {{?}}
				
			</ul>
		</script>
		<script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
		<script src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
		<script src="/scripts/date-timer.js"></script>
		<script src="/scripts/doT.js"></script>
		<script>
			var config = {};
			$.ajax({
				url:'/v1/dict/cate',
				type:'GET',
				dataType:"JSON",
				success:function(res){
					config = res;
				}
			});
		</script>
		<script>
			var pagination = {
				limit:<%= typeof limit === "undefined" ? 8:limit %>,
				count:<%= count %>,
				page:1,
				current:<%= current %>,
				pagegroup:5,
				lists:[]
			};
			var paginationTpl = doT.template($("#paginationTpl").text());
			pagination.page = Math.ceil(pagination.count / pagination.limit);

			setCurrent(pagination.current);
			function setCurrent(current,event){
				pagination.current = current;
				pagination.lists = pageGroupList(pagination);
				$("#pagination,#paginationTop").html(paginationTpl(pagination));
				if(window.history.pushState&&event){
					window.history.pushState({page:current},"",event.target.href);
				}
			}
			window.onpopstate = function(event) {
				if(window.history.state && typeof window.history.state.page==='number'){
					setCurrent(window.history.state.page);
					loadNewPage(window.history.state.page);
				}
			};
			function pageGroupList(pageInfo){ // 获取分页页码
				if(<%= isMobile %>){
					return [];
				};
	            var len = pageInfo.page , temp = [], list = [], count = Math.floor(pageInfo.pagegroup / 2) ,center = pageInfo.current;
	            if( len <= pageInfo.pagegroup ){
	                while(len--){ temp.push({text:pageInfo.page-len,val:pageInfo.page-len});};
	                return temp;
	            }
	            while(len--){ temp.push(pageInfo.page - len);};
	            var idx = temp.indexOf(center);                
	            (idx < count) && ( center = center + count - idx); 
	            (pageInfo.current > pageInfo.page - count) && ( center = pageInfo.page - count);
	            temp = temp.splice(center - count -1, pageInfo.pagegroup);                
	            do {
	                var t = temp.shift();
	                list.push({
	                    text: t,
	                    val: t
	                });
	            }while(temp.length);                
	            if( pageInfo.page > pageInfo.pagegroup ){
	                (pageInfo.current > count + 1) && list.unshift({ text:'...',val: list[0].val - 1 });
	                (pageInfo.current < pageInfo.page - count) && list.push({ text:'...',val: list[list.length - 1].val + 1 });
	            }
	            return list;
	        }

	        var interText = doT.template($("#interpolationtmpl").text());
	        function loadNewPage(page){
				$.ajax({
					url:'/v1/articles',
					type:'GET',
					dataType:"JSON",
					data:{
						page:page,
						limit:pagination.limit
					},
					success:function(res){
						for(var i=0,len=res.data.length;i<len;i++){
							var item = res.data[i];
							item.cate_name = config[item.cate]&&config[item.cate].name;
							if(item.cate_name){
								item.sub_cate_name = config[item.cate].sub[item.sub_cate];
							}
						};
						$("#articles").html(interText(res));
						$("img.lazy").lazyload({
		                    effect : "fadeIn"
		                });
					}
				}); 
			}

			$(function(){
				var dateTimer = new DateTimer({
					url:'/v1/articles',
					currentDate:<%= typeof date === "undefined" %> ? new Date():new Date("<%= typeof date === 'string'&&date %>"),
					handler:function(dateStr){
						location.href="/date/"+dateStr;
					}
				});
				$("img.lazy").lazyload({
                    effect : "fadeIn"
                });
			});
		</script>
		<script>
			(function(){
			    var bp = document.createElement('script');
			    var curProtocol = window.location.protocol.split(':')[0];
			    if (curProtocol === 'https') {
			        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
			    }
			    else {
			        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
			    }
			    var s = document.getElementsByTagName("script")[0];
			    s.parentNode.insertBefore(bp, s);
			})();
		</script>
	</body>
</html>